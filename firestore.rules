rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function getProjectRoles() {
      return get(/databases/$(database)/documents/projects/$(projectId)).data.roles;
    }
    
    function isProjectMember() {
      return isAuth() && request.auth.uid in getProjectRoles();
    }
    
    function isProjectOwner() {
      return isProjectMember() && getProjectRoles()[request.auth.uid] == 'Owner';
    }
    
    function isProjectEditor() {
      return isProjectMember() && (getProjectRoles()[request.auth.uid] == 'Editor' || isProjectOwner());
    }

    // /users/{userId}
    match /users/{userId} {
      allow read, update, write: if isUser(userId);
    }
    
    // /projects/{projectId}
    match /projects/{projectId} {
      allow read: if isProjectMember();
      allow create: if isAuth() && request.resource.data.roles[request.auth.uid] == 'Owner';
      allow update, delete: if isProjectOwner();
      
      // Subcollections
      match /{subcollection}/{docId} {
        allow read, list: if isProjectMember();
        allow write: if isProjectEditor(); // create, update, delete
      }
    }
  }
}
